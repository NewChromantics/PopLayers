<html>
<head>
<title>Pop Layers</title>
<script src="./WebComponent_TreeView/TreeView.js" type=module></script>
<script src="./WebComponent_ThumbnailList/ThumbnailList.js" type=module></script>
<style>

canvas
{
	width:	256px;
	height:	256px;
}

:root
{
	--ChequerBoardSize:		15px;
	--ChequerBoardColourA:	#ccf;/*#89d;*/
	--ChequerBoardColourB:	#eee;/*#cce;*/
	--ChequerBoardBackground:		repeating-conic-gradient( var(--ChequerBoardColourA) 0% 25%, var(--ChequerBoardColourB) 0% 50%) 50% / var(--ChequerBoardSize) var(--ChequerBoardSize);

}

body
{
	--Spacing:	1em;
	
	background:	#333;
	padding:	0px;
	margin:		var(--Spacing);
	overflow:	hidden;

	/* stretch grid to fill */
	height:		100vh;
	
	display:	grid;
	grid-template-areas:	"Workspace Thumbnails"
							;
	grid-template-columns:	1.0fr 0.3fr;
	align-items:		normal;
	justify-items:		normal;
	
	grid-column-gap:	var(--Spacing);
	grid-row-gap:		var(--Spacing);
}

#Workspace
{
	display:	grid;
	grid-template-areas:	"Error"
							"Progress"
							"Preview"
							"Uniforms"
							;
	grid-template-rows:		0.0fr 0.05fr 1.0fr 0.4fr;
}

#Preview
{
	background:	var(--ChequerBoardBackground);
	
	grid-area:	Preview;
	min-height:	10vh;
}

#Uniforms
{
	background:	#eee;
	grid-area:	Uniforms;
	min-height:	10vh;
	display:	block;
}

#Thumbnails
{
	overflow:	auto;
	background:	#eee;
	/*
	display:	grid;
	grid-template-columns:	1fr;
	grid-auto-rows: 1fr;
	grid-column-gap: 30px;
	grid-row-gap: 30px;
	*/
}

#Thumbnails > *
{
	width:		100%;
	display:	block;
	padding:	0em;
	margin:		0em;
	
	background:	var(--ChequerBoardBackground);
}

#Thumbnails img[selected]
{
	border:		2px solid red;
}

#Thumbnails > div *
{
	display:	block;
}

#Thumbnails > div span
{
	pointer-events:	none;
}

#Thumbnails > div
{
	border:		dashed 1px #000;
	padding:	1em;
	
	display:	grid;
	align-items:		center;
	justify-items:		center;
}

#Progress
{
	grid-area:	Progress;
	background:	#ff0;
	padding:	1em;
}

#InputVideo
{
	grid-area:	InputVideo;
	background:	#efe;
	padding:	1em;
}

#OutputDepth
{
	grid-area:	OutputDepth;
	background:	#ffe;
	padding:	1em;
}

#Error,
#Info
{
	display:	block;
	grid-area:	Error;
	background:	#d33;
	color:		#fff;
	border:		1px solid #fff;
	padding:	0.5em;
	margin:		1em;
}

#Info
{
	grid-area:	Info;
	background:	#3d3;
}

#Error:empty,
#Info:empty
{
	display:	none;
}

</style>

</head>
<body>

<script>
	var QueueNewVideoFunction = function(){	throw `QueueNewVideoFunction not assigned`;	};
	var OnAddFragLayer = function(){	throw `OnAddFragLayer not assigned`; };
	
	function LoadCatMp4()
	{
		QueueNewVideoFunction(`Cat2.mp4`);
	}
	
	function SetProgress(FrameCompleted,FrameCount)
	{
		const Div = document.querySelector(`#Progress`);
		const Text = `${FrameCompleted}/${FrameCount}`;
		Div.innerText = Text;
	}
	
	function OnError(Error)
	{
		const Div = document.querySelector(`#Error`);
		const Text = Error ? `${Error}` : '';
		Div.innerText = Text;
	}
	
	function GetLayerThumbnailImages()
	{
		return Array.from( document.querySelectorAll(`#Thumbnails img`) );
	}
		
	function SelectThumbnailElement(Element,Index)
	{
		const ThumbnailsDiv = document.querySelector(`#Thumbnails`);
		
		let LayerThumbnailImages = GetLayerThumbnailImages();
		LayerThumbnailImages.forEach( img => img.removeAttribute('selected') );
		Element.setAttribute('selected',true);
		
		if ( ThumbnailsDiv.OnSelectionChanged )
			ThumbnailsDiv.OnSelectionChanged(Index);
	}
	
	function GetLayerThumbnailElement(LayerIndex)
	{
		const ThumbnailsDiv = document.querySelector(`#Thumbnails`);
		
		let LayerThumbnailImages = GetLayerThumbnailImages();
		
		//	add images to document if some are missing
		while ( LayerIndex >= LayerThumbnailImages.length )
		{
			const NewImageIndex = LayerThumbnailImages.length;
			let NewImage = document.createElement('img');
			NewImage.onclick = () => SelectThumbnailElement(NewImage,NewImageIndex);

			ThumbnailsDiv.appendChild( NewImage );
			LayerThumbnailImages = GetLayerThumbnailImages();
		}
		
		return LayerThumbnailImages[LayerIndex];
	}
	
	function AddFragLayer()
	{
		OnAddFragLayer();
	}
	
</script>

<div id=Workspace>
	<div id=Error></div>
	<div id=Progress>0/0</div>
	<canvas id=Preview></canvas>
	<tree-view id=Uniforms json='' css="WebComponent_TreeView/TreeView.css"></tree-View>
</div>

<div id=Thumbnails>
	<div id=DropZone>
		<span>Drop .mp4 Layer</span>
		<button onclick="LoadCatMp4()">Load Cat.mp4</button>
	</div>
	<div id=AddLayerBox>
		<span>Add new frag layer</span>
		<button onclick="AddFragLayer()">Add Frag Layer</button>
	</div>
</div>

<script type="module">


import LayerManager_t from './LayerManager.js'
import LayerFrag from './LayerFrag.js'
import {Yield} from './PopEngine/PopWebApiCore.js'

let LayerManager;


OnAddFragLayer = function()
{
	const Layer = new LayerFrag();
	LayerManager.InsertLayer( Layer );
}

function SetupThumbnailUi()
{
	const ThumbnailsDiv = document.querySelector(`#Thumbnails`);
	const UniformsElement = document.querySelector(`#Uniforms`);
	function OnLayerSelected(Index)
	{
		UniformsElement.onchange = null;

		const Layer = LayerManager.GetLayer(Index);
		const LayerUniforms = Layer.GetUniforms();
		const LayerUniformMeta = {};
		for ( let UniformName in LayerUniforms )
			LayerUniformMeta[UniformName] = { Writable:true };
		UniformsElement.meta = LayerUniformMeta;
		UniformsElement.json = LayerUniforms;
		
		UniformsElement.onchange = function(NewUniforms)
		{
			Layer.SetUniforms(NewUniforms);
			LayerManager.OnLayerChanged(Layer,`Changed uniforms`);
		}
	}
	ThumbnailsDiv.OnSelectionChanged = OnLayerSelected;
}
SetupThumbnailUi();

async function LoadFromLocalStorage(LayerManager)
{
	const StructureJson = window.localStorage.getItem('LayerManagerStructure');
	if ( !StructureJson )
		return false;
	
	const Structure = JSON.parse( StructureJson );
	LayerManager.LoadStructure(Structure,`LocalStorage`);
	return true;
}

async function SaveToLocalStorage(LayerManager)
{
	//	should switch to indexedDB once we need to store blobs (images probably)
	//	https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API
	const Structure = await LayerManager.GetStructure();
	//	todo: convert back to make sure we haven't lost anything in translation?
	const StructureJson = JSON.stringify( Structure );
	window.localStorage.setItem('LayerManagerStructure',StructureJson);
}

const DefaultFragShader = `precision highp float;
varying vec2 FragUv;
uniform float FrameTimeMs;
void main()
{
	float TimeNorm = fract( FrameTimeMs / 1000.0);
	gl_FragColor = vec4( FragUv, 0, 0.5 );
	float Stripe = length(FragUv - vec2(0.5));
	gl_FragColor.z = abs(Stripe-TimeNorm) < 0.05 ? 0.0 : 1.0;
	gl_FragColor.w = max( gl_FragColor.z, gl_FragColor.w );
}
`;

async function AppStartup()
{
	const Canvas = document.querySelector(`#Preview`);
	LayerManager = new LayerManager_t(Canvas);

	const AnyLoaded = await LoadFromLocalStorage(LayerManager);
	
	//	load a default frag layer
	if ( !AnyLoaded )
	{
		const Layer0 = new LayerFrag();
		Layer0.Frag = DefaultFragShader;
		LayerManager.InsertLayer( Layer0, 0 );
	}
	
	async function SaveLayerManagerThread()
	{
		while ( true )
		{
			await LayerManager.WaitForStructureChange();
			await SaveToLocalStorage(LayerManager);
		}
	}
	SaveLayerManagerThread();
	
	
	//	todo: render only when
	//	- user changes time
	//	- user changes uniforms
	//	- auto playback (user changing time)
	//	- sequence rendering (user changing time too)
	
	async function OnLayerImage(LayerIndex,Image)
	{
		const ImageElement = GetLayerThumbnailElement(LayerIndex);
		const ImageUrl = await Image.GetDataUrl();
		ImageElement.src = ImageUrl;
	}
	
	let FrameTimeMs = 0;
	while ( true )
	{
		FrameTimeMs += 1000/60;
		await LayerManager.Render( FrameTimeMs, OnLayerImage );
	}
}
AppStartup();


</script>

</body>
</html>
